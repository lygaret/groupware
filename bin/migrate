#!/usr/bin/env ruby
# frozen_string_literal: true

require_relative "../config/system"
System::Container.finalize!

require "optparse"

options = {}
OptionParser.new do |opts|
  opts.banner = "Usage: migrate [options]"

  opts.on("-t", "--target INTEGER", Integer, "the target version of the database") do |v|
    options[:target] = v
  end

  opts.on("-d", "--dump PATH", String, "a path to put a schema dump after migration") do |p|
    options[:dump] = p
  end
end.parse!

# because we need specific database setup,
# we can't use the `sequel -m` cli for migrations

connection = System::Container["db.connection"]
migrations = System::Container.root.join "config/migrations"

Sequel.extension :migration

migrator = Sequel::IntegerMigrator.new(connection, migrations, target: options[:target], use_transactions: true)
migrator.run

if options[:dump]
  path = File.expand_path options[:dump]
  File.open(path, "w") do |file|
    version = migrator.send(:current_migration_version)

    file.puts "-- #{Time.now.httpdate} -- Migration Version #{version}"
    file.puts

    objects = connection[:sqlite_master]
      .exclude(sql: nil)
      .select(:sql, :type, :tbl_name, :name)
      .to_hash_groups(:tbl_name)

    objects.each do |(_, objects)|
      objects.each do |object|
        file.puts object[:sql] + ";"
      end
      file.puts
    end
  end
end
